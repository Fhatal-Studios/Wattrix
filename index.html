<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<title>Wattrix – EV Charge Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0b0f1a" />
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%236d5ef7'/%3E%3Cstop offset='1' stop-color='%2338bdf8'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpolygon points='24,4 44,28 32,28 48,60 20,32 34,32' fill='url(%23g)'/%3E%3C/svg%3E">
<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2697517525197581"
     crossorigin="anonymous"></script>
<style>
  :root{
    --bg:#0b0f1a; --panel:#0f1629; --card:#121a2c; --muted:#9aa3b2; --text:#e5e7eb;
    --brand1:#6d5ef7; --brand2:#38bdf8;
    --ok:#38bdf8; --warn:#f59e0b; --danger:#ef4444;
    --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,sans-serif}
  header{padding:28px 20px 18px;text-align:center}
  .logo-wrap{display:flex;justify-content:center;align-items:center;gap:12px}
  .logo-icon{width:48px;height:48px}
  .logo-text{font-size:38px;font-weight:700;background:linear-gradient(90deg,var(--brand1),var(--brand2));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent}
  header .sub{margin:8px 0 2px;color:var(--muted)}
  header .tag{margin:2px 0 0;color:#cfd7ea;font-weight:600;letter-spacing:.2px}
  .container{max-width:1200px;margin:0 auto;padding:0 20px 28px}
  .grid{display:grid;gap:18px}
  @media(min-width:1000px){.grid{grid-template-columns:1.1fr 1fr}}
  .card{background:var(--card);border:1px solid #1c2540;border-radius:20px;box-shadow:var(--shadow)}
  .card h2{margin:0;padding:14px 16px 0;font-size:18px}
  .card .content{padding:16px 16px 18px}
  /* --- Form layout --- */
  .form-grid{display:grid;gap:14px}
  @media(min-width:900px){.form-grid{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:899px) and (min-width:600px){.form-grid{grid-template-columns:repeat(2,1fr)}}
  .field label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  .pair{display:grid;grid-template-columns:1fr 108px;gap:10px} /* input + select pairs */
  .pair.tight{grid-template-columns:1fr 96px}
  input,select{
    width:100%;height:44px;padding:10px 12px;border-radius:12px;
    border:1px solid #24304f;background:#0f1629;color:var(--text);outline:none
  }
  input:focus,select:focus{border-color:var(--brand1);box-shadow:0 0 0 3px rgba(109,94,247,.12)}
  /* number spinners off */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #2a3660;
    background:#0f1629;
    cursor:pointer;
    font-size:12px;
    color:#fff;
  }
  .btnbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #2a3660;background:#151d31;color:var(--text);cursor:pointer}
  .btn:hover{border-color:var(--brand1)}
  .errors{display:none;margin-top:10px;background:#2a1420;border:1px solid #5c2234;color:#ffd7de;padding:10px;border-radius:12px}
  /* --- Results --- */
  .kpis{display:grid;gap:12px}
  @media(min-width:640px){.kpis{grid-template-columns:repeat(3,1fr)}}
  .kpi{background:#121a2c;border:1px solid #1f2946;border-radius:14px;padding:16px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .value{font-size:22px;margin-top:6px}
  .value.ok{color:var(--ok)} .value.warn{color:var(--warn)} .value.danger{color:var(--danger)}
  .divider{height:1px;background:#1d2745;margin:16px 0}
  details{border:1px solid #1c2540;border-radius:14px;background:#10182c;overflow:hidden}
  summary{padding:12px 14px;cursor:pointer;list-style:none}
  summary::-webkit-details-marker{display:none}
  details .section{padding:12px 14px 16px}
  canvas{width:100%;height:180px;background:#0f1629;border-radius:12px;border:1px solid #24304f}
  /* --- Loading overlay --- */
  #loadingOverlay {
    position:fixed; inset:0; z-index:9999;
    background:var(--bg);
    display:flex; align-items:center; justify-content:center;
    transition:opacity 0.6s cubic-bezier(.4,0,.2,1);
  }
  #loadingOverlay.hide {
    opacity:0; pointer-events:none;
  }
  .loading-icon {
    width:72px; height:72px;
    animation:spin 1.2s linear infinite;
    display:block;
  }
  @keyframes spin {
    0% {transform:rotate(0deg);}
    100% {transform:rotate(360deg);}
  }
  /* --- Ad banner --- */
  #adBanner {
    max-width: 1200px;
    margin: 0 auto 18px auto;
    padding: 14px 0;
    text-align: center;
    background: #181f33;
    border: 1px solid #28345a;
    border-radius: 14px;
    color: #9aa3b2;
    font-size: 17px;
    font-weight: 500;
    letter-spacing: .1px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
  }
  .wattrix-adsense {
    max-width: 1200px;
    margin: 0 auto 18px auto;
    padding: 0;
    background: #181f33;
    border: 1px solid #28345a;
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60px;
  }
  @media (max-width: 700px) {
    .wattrix-adsense { min-height: 48px; }
  }
  /* --- Language selector --- */
  .lang-switcher {
    position: absolute;
    top: 22px;
    right: 32px;
    z-index: 10;
    font-size: 15px;
    user-select: none;
  }
  @media (max-width: 600px) {
    .lang-switcher { 
      position: static;
      margin: 12px auto 0 auto;
      display: flex;
      justify-content: center;
      width: max-content;
    }
  }
  .lang-btn {
    display: flex;
    align-items: center;
    gap: 7px;
    background: #181f33;
    color: #9aa3b2;
    border: 1px solid #28345a;
    border-radius: 10px;
    padding: 7px 14px 7px 12px;
    font-weight: 500;
    cursor: pointer;
    transition: border .15s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    outline: none;
  }
  .lang-btn:hover, .lang-btn:focus {
    border-color: var(--brand1);
    color: #fff;
  }
  .lang-btn svg {
    width: 18px; height: 18px; vertical-align: middle;
    fill: #38bdf8;
  }
  .lang-dropdown {
    display: none;
    position: absolute;
    right: 0;
    margin-top: 5px;
    background: #181f33;
    border: 1px solid #28345a;
    border-radius: 10px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.13);
    min-width: 120px;
    z-index: 100;
  }
  .lang-switcher.open .lang-dropdown { display: block; }
  .lang-option {
    padding: 10px 18px 10px 18px;
    color: #e5e7eb;
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    font-size: 15px;
    cursor: pointer;
    border-radius: 0;
    transition: background .13s;
  }
  .lang-option.selected, .lang-option:hover {
    background: #232b45;
    color: #38bdf8;
  }
</style>
</head>
<body>
<!-- Loading overlay -->
<div id="loadingOverlay">
  <svg class="loading-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" aria-label="Loading">
    <defs>
      <linearGradient id="gradBolt2" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#6d5ef7"/><stop offset="100%" stop-color="#38bdf8"/>
      </linearGradient>
    </defs>
    <polygon points="24,4 44,28 32,28 48,60 20,32 34,32" fill="url(#gradBolt2)"/>
  </svg>
</div>

<!-- AdSense banner (below header, above grid) -->
<div class="wattrix-adsense">
  <ins class="adsbygoogle"
       style="display:block;width:100%;height:60px"
       data-ad-client="ca-pub-2697517525197581"
       data-ad-slot="1912268587"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (window.adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<header>
  <div class="logo-wrap">
    <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" aria-label="Wattrix icon">
      <defs>
        <linearGradient id="gradBolt" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#6d5ef7"/><stop offset="100%" stop-color="#38bdf8"/>
        </linearGradient>
      </defs>
      <polygon points="24,4 44,28 32,28 48,60 20,32 34,32" fill="url(#gradBolt)"/>
    </svg>
    <div class="logo-text">WATTRIX</div>
  </div>

  <!-- Language selector (modern floating button) -->
  <div class="lang-switcher" id="langSwitcher">
    <button class="lang-btn" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
      <svg viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm6.93 7h-3.02A12.1 12.1 0 0013 4.36 6.03 6.03 0 0116.93 9zM10 4.06c.7.9 1.3 2.13 1.67 3.94H8.33C8.7 6.19 9.3 4.96 10 4.06zM4.36 11A10.7 10.7 0 014 10c0-.34.01-.67.04-1h3.02A13.6 13.6 0 007 15.64 6.03 6.03 0 013.07 11zm.57-2A10.7 10.7 0 014 10c0 .34.01.67.04 1h3.02A13.6 13.6 0 007 4.36 6.03 6.03 0 013.07 9zm9.63 2c-.13.93-.33 1.8-.6 2.64-.37 1.08-.84 2.01-1.33 2.7A6.03 6.03 0 0016.93 11h-3.02zm-2.7 4.3c-.37.53-.76.94-1.16 1.24-.4-.3-.79-.71-1.16-1.24-.37-.53-.7-1.17-.96-1.87h4.24c-.26.7-.59 1.34-.96 1.87zM10 15.94c-.7-.9-1.3-2.13-1.67-3.94h3.34c-.37 1.81-.97 3.04-1.67 3.94z"/></svg>
      <span id="langBtnLabel">Suomi</span>
      <svg style="width:14px;height:14px;fill:#9aa3b2;" viewBox="0 0 20 20"><path d="M5.5 8l4.5 4.5L14.5 8z"/></svg>
    </button>
    <div class="lang-dropdown" id="langDropdown" role="listbox">
      <button class="lang-option" data-lang="fi" id="langOptFi">Suomi</button>
      <button class="lang-option" data-lang="en" id="langOptEn">English</button>
    </div>
  </div>

  <p class="sub" data-i18n="subtitle">Suunnittele sähköauton lataus – energia, aika ja kustannukset helposti.</p>
  <p class="tag" data-i18n="tagline">Sähköauton latausmatriisi.</p>
</header>

<div class="container grid">
  <!-- Inputs -->
  <section class="card" aria-labelledby="inputs-title">
    <h2 id="inputs-title" data-i18n="inputsTitle">Syötteet</h2>
    <div class="content">
      <div class="form-grid">
        <div class="field">
          <label data-i18n="usableKWh">Akun kapasiteetti (kWh)</label>
          <input id="usableKWh" type="number" min="1" step="0.1" placeholder="esim. 75">
        </div>
        <div class="field">
          <label data-i18n="avgEff">Keskimääräinen kulutus</label>
          <div class="pair">
            <input id="whPerKm" type="text" inputmode="decimal" placeholder="esim. 170">
            <select id="unitDist">
              <option value="km">Wh/km</option>
              <option value="mi">Wh/mi</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label data-i18n="chargerPower">Laturin teho (kW)</label>
          <input id="chargerPower" type="text" inputmode="decimal" placeholder="esim. 11" value="11">
        </div>
        <div class="field">
          <label data-i18n="pricePerKWh">Sähkön hinta</label>
          <div class="pair tight">
            <input id="pricePerKWh" type="text" inputmode="decimal" placeholder="esim. 0.20" value="0.20">
            <select id="currency"><option>€</option><option>$</option><option>£</option></select>
          </div>
        </div>
        <div class="field">
          <label data-i18n="tripDist">Matkan pituus</label>
          <div class="pair">
            <input id="tripKm" type="text" inputmode="decimal" placeholder="esim. 150">
            <select id="distUnit"><option value="km">km</option><option value="mi">mi</option></select>
          </div>
        </div>
        <div class="field">
          <label data-i18n="bufferPct">Turvamarginaali (%)</label>
          <input id="bufferPct" type="text" inputmode="decimal" placeholder="0" value="0">
          <div class="chips">
            <button type="button" class="chip" data-buf="5">+5%</button>
            <button type="button" class="chip" data-buf="10">+10%</button>
            <button type="button" class="chip" data-buf="15">+15%</button>
          </div>
        </div>
        <div class="field">
          <label data-i18n="socFrom">Nykyinen lataustaso (%)</label>
          <input id="socFrom" type="text" inputmode="decimal" placeholder="esim. 20" value="20">
        </div>
        <div class="field">
          <label data-i18n="socTo">Tavoite lataustaso (%)</label>
          <input id="socTo" type="text" inputmode="decimal" placeholder="esim. 80" value="80">
        </div>
        <div class="field">
          <label data-i18n="plannedChargeHours">Suunniteltu latausaika ennen matkaa (h)</label>
          <input id="plannedChargeHours" type="text" inputmode="decimal" placeholder="esim. 3">
          <div id="chargeTimeHint" style="color:var(--muted);font-size:12px;margin-top:4px"></div>
        </div>
      </div>

      <div class="btnbar">
        <button id="copyBtn" class="btn" data-i18n="copyBtn">Kopioi tulokset</button>
        <button id="printBtn" class="btn" data-i18n="printBtn">Tulosta</button>
        <div style="flex:1"></div>
        <button id="resetBtn" class="btn" data-i18n="resetBtn">Tyhjennä</button>
      </div>

      <div id="errorBox" class="errors" role="alert" aria-live="polite"></div>
    </div>
  </section>

  <!-- Results -->
  <section class="card" aria-labelledby="results-title">
    <h2 id="results-title" data-i18n="resultsTitle">Tulokset</h2>
    <div class="content">
      <div class="kpis" aria-live="polite">
        <div class="kpi"><div class="label" data-i18n="kpiEnergy">Energia</div><div class="value ok" id="kpiEnergy">0.0 kWh</div></div>
        <div class="kpi"><div class="label" data-i18n="kpiTime">Aika</div><div class="value" id="kpiTime">0h 00m</div></div>
        <div class="kpi"><div class="label" data-i18n="kpiCost">Kustannus</div><div class="value warn" id="kpiCost">€0.00</div></div>
      </div>
      <div class="divider"></div>
      <!-- Inline AdSense ad (bottom of results card, optional) -->
      <div class="wattrix-adsense" style="margin-top:0;">
        <ins class="adsbygoogle"
             style="display:block;width:100%;height:60px"
             data-ad-client="ca-pub-2697517525197581"
             data-ad-slot="1912268587"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <details open>
        <summary data-i18n="breakdownTitle">Yksityiskohdat</summary>
        <div class="section">
          <ul id="breakdown" style="margin:8px 0 0 20px"></ul>
        </div>
      </details>
    </div>
  </section>
</div>

<script>
const $ = id => document.getElementById(id);
const clamp = (n, a, b) => Math.min(Math.max(n, a), b);

// --- Local Storage helpers ---
const STORAGE_KEY = 'wattrixInputs';
function saveInputsToStorage() {
  const fields = [
    'usableKWh','whPerKm','unitDist','chargerPower','pricePerKWh','currency',
    'tripKm','distUnit','bufferPct','socFrom','socTo','plannedChargeHours'
  ];
  const data = {};
  fields.forEach(id => {
    const el = $(id);
    if (el) data[id] = el.value;
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function loadInputsFromStorage() {
  try {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (!data) return;
    Object.entries(data).forEach(([id, val]) => {
      const el = $(id);
      if (el) el.value = val;
    });
  } catch {}
}
function clearInputsStorage() {
  localStorage.removeItem(STORAGE_KEY);
}

// --- i18n helpers ---
const i18n = {
  fi: {
    subtitle: "Suunnittele sähköauton lataus – energia, aika ja kustannukset helposti.",
    tagline: "Sähköauton latausmatriisi.",
    inputsTitle: "Syötteet",
    usableKWh: "Akun kapasiteetti (kWh)",
    avgEff: "Keskimääräinen kulutus",
    chargerPower: "Laturin teho (kW)",
    pricePerKWh: "Sähkön hinta",
    tripDist: "Matkan pituus",
    bufferPct: "Turvamarginaali (%)",
    socFrom: "Nykyinen lataustaso (%)",
    socTo: "Tavoite lataustaso (%)",
    plannedChargeHours: "Suunniteltu latausaika ennen matkaa (h)",
    copyBtn: "Kopioi tulokset",
    printBtn: "Tulosta",
    resetBtn: "Tyhjennä",
    resultsTitle: "Tulokset",
    kpiEnergy: "Energia",
    kpiTime: "Aika",
    kpiCost: "Kustannus",
    breakdownTitle: "Yksityiskohdat",
    errors: {
      cap: "Akun käytettävä kapasiteetti oltava yli 0.",
      eff: "Keskimääräinen kulutus oltava yli 0.",
      pwr: "Laturin teho oltava yli 0.",
      dist: "Matkan pituus oltava yli 0.",
      soc: "Nykyinen lataustaso % oltava välillä 0–100."
    },
    breakdown: {
      trip: "Matka:",
      distance: "Pituus",
      energyWithBuffer: "Tarvittava energia (sis. marginaali)",
      beforeCharge: "Akun tila ennen latausta:",
      available: "Saatavilla",
      charging: "Lataustarve:",
      shortfall: "Energiavaje",
      requiredTime: "Tarvittava latausaika",
      cost: "Tarvittavan energian kustannus",
      suggestionNeed: "Vinkki: Sinun täytyy ladata vähintään",
      suggestionEnough: "Vinkki: Akussa riittävästi energiaa.",
      suggestionSuffix: "ennen matkaa.",
      planned: "Suunniteltu lataus:",
      energyAdded: "Lisätty energia",
      afterCharge: "Akun tila latauksen jälkeen",
      atDest: "Perillä",
      warningNotEnough: "Varoitus: Energia ei riitä matkalle! Lataa lisää matkalla.",
      destBat: "Akun tila perillä",
      plannedCost: "Latauksen kustannus",
      afterTrip: "Matkan jälkeen (ilman latausta):",
      chargeHint: (from, to, h, m, pwr) => `Latausaika ${from}% → ${to}%: <b>${h}h ${m.toString().padStart(2,'0')}m</b> @ ${pwr} kW`,
      chargeHintInvalid: "Tavoite latausprosentti oltava suurempi kuin nykyinen."
    }
  },
  en: {
    subtitle: "Plan your EV charging – energy, time, and cost made simple.",
    tagline: "The EV charging matrix.",
    inputsTitle: "Inputs",
    usableKWh: "Usable battery capacity (kWh)",
    avgEff: "Average efficiency",
    chargerPower: "Charger power (kW)",
    pricePerKWh: "Electricity price",
    tripDist: "Trip distance",
    bufferPct: "Safety buffer (%)",
    socFrom: "Current charge (%)",
    socTo: "Target charge (%)",
    plannedChargeHours: "Planned charging time before trip (hours)",
    copyBtn: "Copy results",
    printBtn: "Print",
    resetBtn: "Reset",
    resultsTitle: "Results",
    kpiEnergy: "Energy",
    kpiTime: "Time",
    kpiCost: "Cost",
    breakdownTitle: "Breakdown",
    errors: {
      cap: "Usable battery capacity must be greater than 0.",
      eff: "Average efficiency must be greater than 0.",
      pwr: "Charger power should be greater than 0.",
      dist: "Trip distance must be greater than 0.",
      soc: "Current charge % must be between 0 and 100."
    },
    breakdown: {
      trip: "Trip:",
      distance: "Distance",
      energyWithBuffer: "Energy needed (with buffer)",
      beforeCharge: "Battery before charging:",
      available: "Available",
      charging: "Charging required:",
      shortfall: "Energy shortfall",
      requiredTime: "Required charging time",
      cost: "Cost for required energy",
      suggestionNeed: "Suggestion: You need to charge for at least",
      suggestionEnough: "Suggestion: You have enough charge to reach your destination.",
      suggestionSuffix: "before your trip.",
      planned: "Planned charging:",
      energyAdded: "Energy added",
      afterCharge: "Battery after charging",
      atDest: "At destination",
      warningNotEnough: "Warning: Not enough energy for trip! You need to charge more on the road.",
      destBat: "Battery at destination",
      plannedCost: "Cost for planned charge",
      afterTrip: "After trip (if no charging):",
      chargeHint: (from, to, h, m, pwr) => `To charge from ${from}% to ${to}%: <b>${h}h ${m.toString().padStart(2,'0')}m</b> at ${pwr} kW`,
      chargeHintInvalid: "Target charge must be greater than current charge."
    }
  }
};

let lang = localStorage.getItem('wattrixLang') || 'fi';

function setLang(newLang) {
  lang = newLang;
  localStorage.setItem('wattrixLang', lang);
  // Update all [data-i18n] elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    let val = i18n[lang][key];
    if (!val && key in i18n[lang].breakdown) val = i18n[lang].breakdown[key];
    if (val) el.textContent = val;
  });
  // Update placeholders
  $('usableKWh').placeholder = lang === 'fi' ? 'esim. 75' : 'e.g. 75';
  $('whPerKm').placeholder = lang === 'fi' ? 'esim. 170' : 'e.g. 170';
  $('chargerPower').placeholder = lang === 'fi' ? 'esim. 11' : 'e.g. 11';
  $('pricePerKWh').placeholder = lang === 'fi' ? 'esim. 0.20' : 'e.g. 0.20';
  $('tripKm').placeholder = lang === 'fi' ? 'esim. 150' : 'e.g. 150';
  $('bufferPct').placeholder = '0';
  $('socFrom').placeholder = lang === 'fi' ? 'esim. 20' : 'e.g. 20';
  $('socTo').placeholder = lang === 'fi' ? 'esim. 80' : 'e.g. 80';
  $('plannedChargeHours').placeholder = lang === 'fi' ? 'esim. 3' : 'e.g. 3';
  // Update breakdown and error messages
  recompute();
}

// Remove this old code, it's not needed anymore and will cause errors:
// $('langSel').value = lang;
// $('langSel').addEventListener('change', e => setLang(e.target.value));

// --- Language switcher UI logic ---
(function(){
  const switcher = document.getElementById('langSwitcher');
  const btn = document.getElementById('langBtn');
  const dropdown = document.getElementById('langDropdown');
  const label = document.getElementById('langBtnLabel');
  const optFi = document.getElementById('langOptFi');
  const optEn = document.getElementById('langOptEn');
  function updateLangUI() {
    label.textContent = lang === 'fi' ? 'Suomi' : 'English';
    optFi.classList.toggle('selected', lang === 'fi');
    optEn.classList.toggle('selected', lang === 'en');
    btn.setAttribute('aria-expanded', switcher.classList.contains('open') ? 'true' : 'false');
  }
  btn.onclick = (e) => {
    switcher.classList.toggle('open');
    updateLangUI();
    e.stopPropagation();
  };
  [optFi, optEn].forEach(opt => {
    opt.onclick = (e) => {
      setLang(opt.dataset.lang);
      switcher.classList.remove('open');
      updateLangUI();
      e.stopPropagation();
    };
  });
  // Close dropdown on outside click
  document.addEventListener('click', () => switcher.classList.remove('open'));
  // Keyboard accessibility
  btn.onkeydown = (e) => {
    if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
      switcher.classList.add('open');
      updateLangUI();
      e.preventDefault();
    }
  };
  dropdown.onkeydown = (e) => {
    if (e.key === 'Escape') {
      switcher.classList.remove('open');
      btn.focus();
    }
  };
  updateLangUI();
})();


// Accept both comma and dot decimals
function num(v, def=0){
  if (v == null) return def;
  const n = parseFloat(String(v).replace(/\s+/g,'').replace(',', '.'));
  return isFinite(n) ? n : def;
}
const fmt = (n, d=1) => isFinite(n) ? Number(n).toFixed(d) : '–';

function recompute(){
  // Read values (comma/dot safe)
  const cap = num($('usableKWh').value);
  const effInput = num($('whPerKm').value);
  const effUnit = $('unitDist').value;     // Wh/km or Wh/mi
  const effWhPerKm = effUnit === 'mi' ? (effInput / 1.60934) : effInput;

  const pwr = num($('chargerPower').value);
  const price = num($('pricePerKWh').value);
  const currency = $('currency').value;

  const tripVal = num($('tripKm').value);
  const distUnit = $('distUnit').value;
  const distanceKm = distUnit === 'mi' ? (tripVal * 1.60934) : tripVal;

  const buf = clamp(num($('bufferPct').value), 0, 50) / 100;
  const from = clamp(num($('socFrom').value), 0, 100);
  const to = clamp(num($('socTo').value), 0, 100);

  const plannedChargeHours = num($('plannedChargeHours').value);

  // Validation
  const errs = [];
  const errTxt = i18n[lang].errors;
  if (cap <= 0) errs.push(errTxt.cap);
  if (effWhPerKm <= 0) errs.push(errTxt.eff);
  if (pwr <= 0) errs.push(errTxt.pwr);
  if (distanceKm <= 0) errs.push(errTxt.dist);
  if (from < 0 || from > 100) errs.push(errTxt.soc);
  // No need to check to > from for this scenario
  const errorBox = $('errorBox');
  if (errs.length){ errorBox.style.display='block'; errorBox.innerHTML = errs.join('<br>'); }
  else { errorBox.style.display='none'; errorBox.innerHTML=''; }

  // --- Calculations ---
  // 1. Energy needed for trip (with buffer)
  const tripKWh = (distanceKm * effWhPerKm / 1000) * (1 + buf);

  // 2. Energy available at current SOC
  const availableKWh = cap * from / 100;

  // 3. Energy shortfall (how much needs to be charged)
  const neededKWh = Math.max(tripKWh - availableKWh, 0);

  // 4. Time needed to charge enough for trip
  const neededChargeHours = pwr > 0 ? neededKWh / pwr : 0;

  // 5. If user enters planned charging time, how much energy will be added
  const plannedAddedKWh = plannedChargeHours > 0 ? plannedChargeHours * pwr : 0;
  // Clamp afterChargeKWh to not exceed battery capacity
  const unclampedAfterChargeKWh = availableKWh + plannedAddedKWh;
  const afterChargeKWh = Math.min(unclampedAfterChargeKWh, cap);
  const afterChargeSOC = cap > 0 ? Math.min(afterChargeKWh / cap * 100, 100) : 0;

  // 6. After driving, how much battery left at destination
  const destKWh = afterChargeKWh - tripKWh;
  const destSOC = cap > 0 ? Math.max(destKWh / cap * 100, 0) : 0;

  // 7. Cost for needed energy
  const neededCost = neededKWh * price;
  // Clamp plannedAddedKWh to not exceed what can actually be added to reach 100%
  const maxAddableKWh = Math.max(cap - availableKWh, 0);
  const plannedCost = Math.min(plannedAddedKWh, maxAddableKWh) * price;

  // KPIs
  $('kpiEnergy').textContent = `${fmt(neededKWh)} kWh`;
  // Format KPI time as Xh YYm
  const kpiH = Math.floor(neededChargeHours);
  const kpiM = Math.round((neededChargeHours - kpiH) * 60);
  $('kpiTime').textContent = `${kpiH}h ${kpiM.toString().padStart(2,'0')}m`;
  $('kpiCost').textContent   = `${currency}${fmt(neededCost,2)}`;

  // --- Breakdown (language aware) ---
  const t = i18n[lang].breakdown;
  const lines = [];
  lines.push(`<strong>${t.trip}</strong>`);
  lines.push(`<ul style="margin-top:2px">`);
  lines.push(`<li>${t.distance}: <b>${fmt(distanceKm)} km</b></li>`);
  lines.push(`<li>${t.energyWithBuffer}: <b>${fmt(tripKWh)} kWh</b></li>`);
  lines.push(`</ul>`);

  lines.push(`<strong>${t.beforeCharge}</strong>`);
  lines.push(`<ul style="margin-top:2px">`);
  lines.push(`<li>${t.available}: <b>${fmt(availableKWh)} kWh</b> (<b>${fmt(from)}%</b>)</li>`);
  lines.push(`</ul>`);

  lines.push(`<strong>${t.charging}</strong>`);
  lines.push(`<ul style="margin-top:2px">`);
  lines.push(`<li>${t.shortfall}: <b>${fmt(neededKWh)} kWh</b></li>`);
  // Format required charging time as Xh YYm
  {
    const h = Math.floor(neededChargeHours);
    const m = Math.round((neededChargeHours - h) * 60);
    lines.push(`<li>${t.requiredTime}: <b>${h}h ${m.toString().padStart(2,'0')}m</b> @ <b>${fmt(pwr)} kW</b></li>`);
  }
  lines.push(`<li>${t.cost}: <b>${currency}${fmt(neededCost,2)}</b></li>`);
  lines.push(`</ul>`);

  // Suggestion for minimum charging time
  if (neededKWh > 0) {
    const h = Math.floor(neededChargeHours);
    const m = Math.round((neededChargeHours - h) * 60);
    lines.push(`<span style="color:#38bdf8"><b>${t.suggestionNeed}</b> <b>${h}h ${m.toString().padStart(2,'0')}m</b> ${t.suggestionSuffix}</span>`);
  } else {
    lines.push(`<span style="color:#38bdf8"><b>${t.suggestionEnough}</b></span>`);
  }

  if (plannedChargeHours > 0) {
    lines.push(`<strong><br>${t.planned}</strong>`);
    lines.push(`<ul style="margin-top:2px">`);
    // Show the actual energy added (clamped) and time as Xh YYm
    const actualAddedKWh = afterChargeKWh - availableKWh;
    const actualAddedHours = pwr > 0 ? actualAddedKWh / pwr : 0;
    const h = Math.floor(actualAddedHours);
    const m = Math.round((actualAddedHours - h) * 60);
    lines.push(`<li>${t.energyAdded}: <b>${fmt(actualAddedKWh)} kWh</b> / <b>${h}h ${m.toString().padStart(2,'0')}m</b></li>`);
    lines.push(`<li>${t.afterCharge}: <b>${fmt(afterChargeKWh)} kWh</b> (<b>${fmt(afterChargeSOC)}%</b>)</li>`);
    if (destKWh < 0) {
      lines.push(`<li><span style="color:#ef4444"><b>${t.atDest}:</b> 0.0 kWh (0%)</span></li>`);
      lines.push(`<li><span style="color:#ef4444"><b>${t.warningNotEnough}</b></span></li>`);
    } else {
      lines.push(`<li>${t.destBat}: <b>${fmt(destKWh)} kWh</b> (<b>${fmt(destSOC)}%</b>)</li>`);
    }
    lines.push(`<li>${t.plannedCost}: <b>${currency}${fmt(plannedCost,2)}</b></li>`);
    lines.push(`</ul>`);
  } else {
    const destKWhNoCharge = availableKWh - tripKWh;
    const destSOCNoCharge = cap > 0 ? Math.max(destKWhNoCharge / cap * 100, 0) : 0;
    lines.push(`<strong><br>${t.afterTrip}</strong>`);
    lines.push(`<ul style="margin-top:2px">`);
    if (destKWhNoCharge < 0) {
      lines.push(`<li><span style="color:#ef4444"><b>${t.atDest}:</b> 0.0 kWh (0%)</span></li>`);
      lines.push(`<li><span style="color:#ef4444"><b>${t.warningNotEnough}</b></span></li>`);
    } else {
      lines.push(`<li>${t.destBat}: <b>${fmt(destKWhNoCharge)} kWh</b> (<b>${fmt(destSOCNoCharge)}%</b>)</li>`);
    }
    lines.push(`</ul>`);
  }
  $('breakdown').innerHTML = lines.join('');
  // --- Show time needed to charge from current to target SOC ---
  let hint = '';
  if (cap > 0 && pwr > 0 && to > from) {
    const kWhNeeded = cap * (to - from) / 100;
    const hours = kWhNeeded / pwr;
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    hint = t.chargeHint(fmt(from,0), fmt(to,0), h, m, fmt(pwr));
  } else if (to <= from) {
    hint = t.chargeHintInvalid;
  }
  $('chargeTimeHint').innerHTML = hint;
}

function bind(){
  // Inputs
  document.querySelectorAll('input, select').forEach(el=>{
    el.addEventListener('input', ()=>{
      recompute();
      saveInputsToStorage();
    });
    el.addEventListener('change', ()=>{
      recompute();
      saveInputsToStorage();
    });
  });
  // Chips
  document.querySelectorAll('.chip').forEach(c=>{
    c.addEventListener('click', ()=>{
      $('bufferPct').value = c.dataset.buf;
      recompute();
      saveInputsToStorage();
    });
  });
  // Actions
  $('copyBtn').onclick = ()=> navigator.clipboard.writeText($('breakdown').innerText||'');
  $('printBtn').onclick = ()=> window.print();
  $('resetBtn').onclick = ()=>{
    document.querySelectorAll('input[type="text"],input[type="number"]').forEach(i=> i.value='');
    $('chargerPower').value='11'; $('pricePerKWh').value='0.20';
    $('socFrom').value='20'; $('socTo').value='80'; $('bufferPct').value='0';
    $('unitDist').value='km'; $('distUnit').value='km'; $('currency').value='€';
    clearInputsStorage();
    recompute();
  };
}

// Loading animation logic
window.addEventListener('DOMContentLoaded', ()=>{
  loadInputsFromStorage();
  setLang(lang);
  setTimeout(()=>{
    const overlay = $('loadingOverlay');
    overlay.classList.add('hide');
    setTimeout(()=>overlay.remove(), 700);
  }, 1500);
});

bind();
recompute();
</script>
<footer style="text-align:center;color:#9aa3b2;font-size:13px;padding:18px 0 8px;">
  &copy; 2025 <a href="https://fhatal.com" style="color:#38bdf8;text-decoration:none;">Fhatal.com</a>
</footer>
</body>
</html>
